name: Build and Release

on:
  push:
    branches: [main, master]
    tags:
      - 'v*'
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        platform: [macos-latest, windows-latest]

    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: npm install

      - name: Build Tauri app
        run: npm run tauri build

      - name: Get version
        id: version
        shell: bash
        run: |
          VERSION=$(node -p "require('./src-tauri/tauri.conf.json').version")
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Upload macOS DMG
        if: matrix.platform == 'macos-latest'
        uses: actions/upload-artifact@v4
        with:
          name: macos-installer-${{ steps.version.outputs.VERSION }}
          path: src-tauri/target/release/bundle/dmg/*.dmg
          retention-days: 30

      - name: Upload Windows MSI
        if: matrix.platform == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer-${{ steps.version.outputs.VERSION }}
          path: src-tauri/target/release/bundle/msi/*.msi
          retention-days: 30

      - name: Upload Windows NSIS (if exists)
        if: matrix.platform == 'windows-latest'
        uses: actions/upload-artifact@v4
        continue-on-error: true
        with:
          name: windows-nsis-${{ steps.version.outputs.VERSION }}
          path: src-tauri/target/release/bundle/nsis/*.exe
          retention-days: 30

  create-release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          VERSION=$(node -p "require('./src-tauri/tauri.conf.json').version")
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Download Windows MSI
        uses: actions/download-artifact@v4
        with:
          name: windows-installer-${{ steps.version.outputs.VERSION }}
          path: ./installers/windows

      - name: Download macOS DMG
        uses: actions/download-artifact@v4
        with:
          name: macos-installer-${{ steps.version.outputs.VERSION }}
          path: ./installers/macos

      - name: Download Windows NSIS (if exists)
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: windows-nsis-${{ steps.version.outputs.VERSION }}
          path: ./installers/windows-nsis

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ./installers/windows/*.msi
            ./installers/macos/*.dmg
            ./installers/windows-nsis/*.exe
          body: |
            ## üéâ Sistema POS Ropa v${{ steps.version.outputs.VERSION }}
            
            ### üì¶ Instaladores disponibles:
            
            **Windows:**
            - `.msi` - Instalador recomendado para Windows
            - `.exe` - Instalador NSIS alternativo (si est√° disponible)
            
            **macOS:**
            - `.dmg` - Instalador para macOS
            
            ---
            
            ### üöÄ C√≥mo instalar:
            
            #### Windows:
            1. Descargar el archivo `.msi`
            2. Doble click en el instalador
            3. Seguir las instrucciones del asistente
            4. La aplicaci√≥n se instalar√° en `C:\Program Files\Sistema POS Ropa\`
            5. Los datos se guardar√°n en `%APPDATA%\Sistema POS Ropa\`
            
            #### macOS:
            1. Descargar el archivo `.dmg`
            2. Abrir el archivo descargado
            3. Arrastrar la aplicaci√≥n a la carpeta Aplicaciones
            4. Los datos se guardar√°n en `~/Library/Application Support/Sistema POS Ropa/`
            
            ---
            
            ### ‚ú® Caracter√≠sticas de esta versi√≥n:
            
            - ‚úÖ Sistema de licencias completo (Trial, Mensual, Anual)
            - ‚úÖ Modo solo lectura cuando la licencia expira
            - ‚úÖ Pantalla de activaci√≥n profesional
            - ‚úÖ Banner de estado de licencia
            - ‚úÖ Generador de c√≥digos de activaci√≥n
            - ‚úÖ Base de datos en AppData (preserva datos al actualizar)
            - ‚úÖ Migraci√≥n autom√°tica desde versiones anteriores
            - ‚úÖ Bloqueo de POS e Inventario en modo lectura
            - ‚úÖ Sistema de control con Excel incluido
            
            ---
            
            ### üîÑ Actualizaci√≥n desde versi√≥n anterior:
            
            Si ya tienes una versi√≥n anterior instalada:
            
            1. **Windows**: El instalador detectar√° autom√°ticamente la versi√≥n anterior
               - Tus datos se preservar√°n autom√°ticamente
               - Los productos, ventas y clientes NO se perder√°n
               - Solo se actualizar√° el c√≥digo de la aplicaci√≥n
            
            2. **macOS**: Simplemente reemplaza la app en la carpeta Aplicaciones
               - Los datos permanecen intactos
            
            ---
            
            ### ‚ö†Ô∏è Notas importantes:
            
            - **Primera instalaci√≥n**: Incluye 15 d√≠as de licencia Trial
            - **Actualizaci√≥n**: Tus datos se preservan autom√°ticamente
            - **Base de datos**: Se guarda en tu carpeta de usuario (no se borra al actualizar)
            - **Licencia**: Despu√©s del trial, necesitar√°s un c√≥digo de activaci√≥n
            
            ---
            
            ### üìû Soporte:
            
            Si tienes problemas con la instalaci√≥n:
            - Verifica que tienes permisos de administrador (Windows)
            - Revisa la documentaci√≥n incluida
            - Contacta a soporte t√©cnico
            
            ---
            
            ### üîê Seguridad:
            
            - Los instaladores est√°n firmados
            - La base de datos se encripta localmente
            - Sistema de validaci√≥n de c√≥digos con checksum
            
            ---
            
            **¬°Gracias por usar Sistema POS Ropa!** üéâ
            
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}